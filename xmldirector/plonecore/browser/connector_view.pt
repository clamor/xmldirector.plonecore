<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="xmldirector.plonecore">
<body>

<metal:slot fill-slot="style_slot">
    <link rel="stylesheet" type="text/css" tal:attributes="href string:$portal_url/++resource++xmldirector.plonecore/jsgrid/jsgrid.min.css" />
    <link rel="stylesheet" type="text/css" tal:attributes="href string:$portal_url/++resource++xmldirector.plonecore/jsgrid/jsgrid-theme.min.css" />
    <link rel="stylesheet" type="text/css" tal:attributes="href string:$portal_url/++resource++xmldirector.plonecore/styles.css" />
</metal:slot>

<metal:slot fill-slot="javascript_head_slot">
    <script type="text/javascript" charset="utf8" tal:attributes="src string:$portal_url/++resource++xmldirector.plonecore/jsgrid/jsgrid.min.js"></script>
</metal:slot>

<metal:main fill-slot="content-core">
  <metal:content-core define-macro="content-core">

      <form tal:attributes="action string:${context/absolute_url}/collection-action" method="POST">
          <div id="table-info">hello</div>
          <table id="table">
          </table>
          <button class="confirm-action button" type="submit" name="action" action="delete" value="delete" data-text="Do you really want to remove the selected items?" i18n:translate="">Delete</button>
          <button class="action-refresh button" name="action-refresh" i18n:translate="">Refresh</button>
          <button class="action-create-collection button" name="action-create-collection" i18n:translate="">Create Collection</button>
      </form>

      <div class="actions">
          <ul>
              <li>
                  <a id="connector-zip-import" class="action" tal:attributes="href string:${context/absolute_url}/connector-zip-import?subpath=${options/subpath}" i18n:translate="">ZIP import</a>
              </li>
              <li>
                  <a id="connector-zip-export" class="action" tal:attributes="href string:${context/absolute_url}/connector-zip-export?subpath=${options/subpath}" i18n:translate="">ZIP export</a>
              </li>
              <li>
                  <a id="connector-reindex" class="action" tal:attributes="href string:${context/absolute_url}/connector-reindex" i18n:translate="">Reindex</a>
              </li>
              <li>
                  <a id="connector-log" class="action" tal:attributes="href string:${context/absolute_url}/persistent-log" i18n:translate="">Log</a>
              </li>
          </ul>
          <form tal:attributes="action string:${context/absolute_url}/create-collection" method="post" id="create-collection-form" style="display: none">
              <label for="name" i18n:translate="">Create collection</label>
              <input type="text" name="name" size="20" />
              <input name="subpath" type="hidden" tal:attributes="value options/subpath" />
              <input type="submit" i18n:attributes="value" value="Create" />
          </form>
          <form tal:attributes="action string:${context/absolute_url}/rename-collection" method="post" id="rename-collection-form" style="display: none">
              <label for="name" i18n:translate="">Rename collection</label>
              <select name="name" id="collection-list">
              </select>
              <input name="subpath" type="hidden" tal:attributes="value options/subpath" />
              <label for="new_name" i18n:translate="">to</label>
              <input type="text" name="new_name" size="20" />
              <input type="submit" i18n:attributes="value" value="Rename" />
          </form>
      </div>

      <script type="text/javascript" 
          tal:define="authenticator context/@@authenticator;
                      auth_value python: authenticator.authenticator('authenticator')"
          tal:content="string: AUTHENTICATOR = '${auth_value}'"
          >
      </script>
      <script type="text/javascript" tal:content="string: var URL = '${context/absolute_url}'"></script>
      <script type="text/javascript" tal:content="string: var SUBPATH = '${options/subpath}'"></script>
      <script type="text/javascript" 
          tal:define="is_plone5 python: str(view.is_plone5()).lower()"
          tal:content="string: var IS_PLONE5 = $is_plone5"></script>
      <script type="text/javascript">

        PAGING = IS_PLONE5; 

        DATA = new Array;

        function get_data(filter) {
            var url = URL + "/@@connector-folder-contents?subpath=" + SUBPATH;

            if (DATA.length == 0) {

                $.ajax({
                    url: url,
                    dataType: 'json',
                    async: false,
                    method: 'GET',
                    success: function(result) {
                        DATA.push.apply(DATA, result['dirs']);
                        DATA.push.apply(DATA, result['files']);

                        /* Update #collection-list */
                        if (result['dirs'].length > 0) {
                            var select = $('#collection-list');
                            $(result['dirs']).each(function(index, d) {
                                if (d['title'] != '..') 
                                    select.append(sprintf('<option value="%s">%s</option>', d['title'], d['title']));
                            });
                            if (select.find('option').length == 0)
                                $('#action-rename-collection').remove();
                        } else {
                            $('#action-rename-collection').remove();
                        }
                    } 
                });
            }

            var result = $.grep(DATA, function(item, idx) {
                for (var key in filter) {
                    var value = filter[key];
                    if (value.length > 0) {
                        if (item[key].indexOf(value) == -1)
                            return false;
                    }
                }
                return true;
            });
            return result;
        }

        function title_renderer(value, item) {
            var url = item['url'];
            var title = item['title'];
            var fullpath = item['fullpath'];
            var type = item['type'];
            var s = '<input type="checkbox" name="paths:list" value="' + fullpath + '"> ';
                s += sprintf('<a class="type-%s" href="%s">%s</a>', type, url, title);
                
            var title = item['title'];
            if (item['type'] == 'directory') {
                console.log(title);
                if (title != '..') {
                    s += sprintf('<a class="action-delete" title="Remove" data-subpath="%s" data-id="%s">', SUBPATH, title);
                    s += '<img src="++resource++xmldirector.plonecore/images/remove.png" title="Remove collection"/>'
                    s += '</a>';
                    s += sprintf('<a title="Rename" class="action-rename" data-fullpath="%s" data-title="%s"><img src="++resource++xmldirector.plonecore/images/rename.png" ></a>', fullpath, title);
                        }
                return s;
            } else {
                var remove_url = item['remove_url'];
                var editable = item['editable'];
                s += sprintf('\
                            <a class="action-delete" title="Remove" data-subpath="%s" data-id="%s">\
                            <img src="++resource++xmldirector.plonecore/images/remove.png" title="Remove item" i18n:attributes="title"/> </a>', 
                        SUBPATH, title);
                s += sprintf('<a title="Rename" class="action-rename" data-fullpath="%s" data-title="%s"><img src="++resource++xmldirector.plonecore/images/rename.png" ></a>', fullpath, title);
                if (editable) {
                    var edit_url = item['edit_url'];
                s += sprintf('<a href="%s" title="Edit" class="action-edit" ><img src="++resource++xmldirector.plonecore/images/edit.png" /></a>', edit_url);
                }
                return s;
            }
                ;
            return s;
        }

        function init_table() {            
            $('#table').jsGrid({
                width: "100%",
                height: "600px",
                autoload: true,
                sorting: true,
                paging: PAGING,
                filtering: true,
                controller: {
                    loadData: get_data
                },

                fields: [
                    { name: "title", title: "Name", type: "text", width: 200,  itemTemplate: title_renderer},
                    /*
                    { name: "type", title: "Type", type: "text", width: 40, css: 'field-type'},
                    */
                    { name: "size", title: "Size", type: "text", width: 40, css: 'field-size', filtering: false},
                    { name: "modified", title: "Last modified", type: "text", width: 50, css: 'field-modified', filtering: false },
                    /*
                    { name: "st_mode_text", title: "Permissions", type: "text", sorting: false, size: 50 , filtering: false},
                    { name: "actions", type: "text", title: "Actions", sorting: false, itemTemplate: action_renderer, filtering: false}
                    */
                ]
            });
        }

        function refresh_table() {
            DATA =  new Array;
            $("#table").jsGrid("refresh");
            init_table();
        }

        $(document).ready(function() {

            $('.action-refresh').on('click', function(e) {
                e.preventDefault();
                refresh_table();
            });
            
            $('body').on('click', '.action-create-collection', function(e) {
                e.preventDefault();
                var new_id = window.prompt('Create new collection');
                if (new_id != null) {
                    var url = sprintf('%s/@@filemanager-create-collection', URL);
                    $.ajax({
                        type: 'GET',
                        url: url,
                        data: {
                            subpath: SUBPATH,
                            new_id: new_id
                        },
                        success: function(result) {
                            $('#table-info').removeClass('status-ok status-error').addClass('status-ok');
                            $('#table-info').text(result).stop(true, true).show().fadeOut(5000);
                            refresh_table();
                        },
                        error: function(result) {
                            console.log(result);
                            $('#table-info').removeClass('status-ok status-error').addClass('status-error');
                            $('#table-info').text(result.responseText).stop(true, true).show().fadeOut(5000);
                        }

                    });
                }
            });
            
            $('body').on('click', '.action-rename', function(e) {
                e.preventDefault();
                var title = $(this).data('title');
                var fullpath = $(this).data('fullpath');
                var msg = sprintf('Rename "%s" to', title);
                var new_id = window.prompt(msg, title);
                var url = sprintf('%s/@@filemanager-rename', URL);
                if (new_id != null) {
                    $.ajax({
                        type: 'GET',
                        url: url,
                        data: {
                            subpath: SUBPATH,
                            old_id: title,
                            new_id: new_id
                        },
                        success: function(result) {
                            $('#table-info').removeClass('status-ok status-error').addClass('status-ok');
                            $('#table-info').text(result).stop(true, true).show().fadeOut(5000);
                            refresh_table();
                        },
                        error: function(result) {
                            console.log(result);
                            $('#table-info').removeClass('status-ok status-error').addClass('status-error');
                            $('#table-info').text(result.responseText).stop(true, true).show().fadeOut(5000);
                        }

                    });
                }
            });
            
            $('body').on('click', '.action-delete', function(e) {
                e.preventDefault();
                var title = $(this).data('title');
                var subpath = $(this).data('subpath');
                var id = $(this).data('id');
                var msg = sprintf('Do you really want to delete "%s/%s" to', subpath, id);
                if (confirm(msg)) {
                    var url = sprintf('%s/@@filemanager-delete', URL);
                    $.ajax({
                        type: 'GET',
                        url: url,
                        data: {
                            subpath: SUBPATH,
                            id: id
                        },
                        success: function(result) {
                            $('#table-info').removeClass('status-ok status-error').addClass('status-ok');
                            $('#table-info').text(result).stop(true, true).show().fadeOut(5000);
                            refresh_table();
                        },
                        error: function(result) {
                            console.log(result);
                            $('#table-info').removeClass('status-ok status-error').addClass('status-error');
                            $('#table-info').text(result.responseText).stop(true, true).show().fadeOut(5000);
                        }

                    });
                }
            });

            init_table();
        });
      </script>

  </metal:content-core>
</metal:main>

</body>
</html>

